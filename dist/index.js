#!/usr/bin/env node
import e from"minimist";import*as t from"node:fs/promises";import n from"node:path";import{request as a}from"node:https";import{ChatOpenAI as o}from"@langchain/openai";import{HumanMessage as i}from"@langchain/core/messages";import{StringOutputParser as s}from"@langchain/core/output_parsers";import r from"ora";const l=e=>n.resolve(process.cwd(),e),c=async e=>/^(https?:\/\/)/.test(e)?await(async e=>{if(!e||!VALID_URL_REG.test(e))throw new Error("Invalid URL");return new Promise(((t,n)=>{const o=[],i=a(e,(e=>{e.setEncoding("base64"),e.on("data",(e=>{o.push(e)})),e.on("end",(()=>{const e=`data:image/jpeg;base64,${o.join("").toString("base64")}`;t(e)}))}));i.on("error",(e=>{console.error(`problem with request: ${e.message}`),n(e.message)})),i.end()}))})(e):(e=>!/^(?:[a-zA-Z]:\\|\/|http:\/\/|https:\/\/|file:\/\/\/)/.test(e))(e)?await(async e=>`data:image/jpeg;base64,${(await t.readFile(l(e))).toString("base64")}`)(e):void 0,h=r();!async function(){const n=e(process.argv.slice(2)),a=n.i;console.log(n);(async(e={},n=[])=>{try{const a=[];for(const e of n)a.push(await c(e));const{openaiApiKey:r,openaiModel:d,openaiBaseUrl:m}=e,u=new o({configuration:{baseURL:m||"https://api.openai.com/v1"},temperature:.95,apiKey:r,model:d||"gpt-4o"});u.frequencyPenalty=void 0,u.n=void 0,u.presencePenalty=void 0,u.topP=void 0;const p=[new i({content:[{type:"text",text:'\nYou are an expert at building single page, funtional apps using HTML, Javascript and CSS.\nYou also have perfect vision and pay great attention to detail.\n\nYou take image of a reference web page from the user, and then build single page apps \nusing HTML, CSS and JS.\nYou may receive additional images, possibly multiple images, that are more detailed complements to the first image you received, perhaps close-ups of a detail.\nYou will need to fully analyze these images and perform an accurate comparative merge, then update the content so that the final result is more like the first image you received.\n\n- Make sure the app looks exactly like the image.\n- Pay close attention to page layout, elements position, Ensure complete consistency with the image. ENSURE CONSISTENT LAYOUT.\n- Pay close attention to background color, text color, font size, button style, font family, \npadding, margin, border, etc. Match the colors and sizes exactly.\n- If some fuctionality requires a backend call, just mock the data instead.\n- MAKE THE APP FUNCTIONAL using Javascript. Allow the user to interact with the app and get the same behavior as the image.\n- Use the exact text from the image.\n- Do not add comments in the code such as "\x3c!-- Add other navigation links as needed --\x3e" and "\x3c!-- ... other news items ... --\x3e" in place of writing the full code. WRITE THE FULL CODE.\n- Repeat elements as needed. For example, if there are 15 items, the code should have 15 items. DO NOT LEAVE comments like "\x3c!-- Repeat for each news item --\x3e" or bad things will happen.\n- For images, use placeholder images from https://placehold.co and include a detailed description of the image in the alt text so that an image generation AI can generate the image later.\n\nIn terms of HTML,\n\n- Ensure that the output content must be a standard HTML5 document. OUTPUT STANDARD HTML5 DOCUMENT.\n- The language version of the HTML document is \'en\'.\n- The first line of this HTML5 document must be "<!DOCTYPE html>". "<!DOCTYPE html>" MUST IN THE FIRST LINE.\n- You need to use modern semantic HTML tags accurately, e.g. header, nav, footer, section, main, article, aside,h1, h2, h3, h4, h5, h6, etc.\n- You need to make the website more SEO friendly.\n- You need to include the <meta> tags in the <head> tag of your document, build like so:\n    <head>\n      <meta charset="UTF-8">\n      <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    </head>\n\n\nIn terms of CSS,\n\n- You can use modern css syntax, e.g. CSS3 syntax.\n- In terms of layout, you can use flex, grid etc.\n- You need to restore the size of the elements as much as possible, such as accurate width and height\n\nIn terms of libraries,\n\n- You can use Google Fonts\n- Font Awesome for icons: <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>\n\nBefore generating the code for the app, think step-by-step: First, analyze the image, if there are multiple images you need to analyze each one, then understand how you will build it and how to structure the code. \nDo the thinking within <thinking></thinking> tags. Then, provide your code within <html></html> tags.\nDo not include markdown ``` or ```html syntax at the start or end.\nFinal Reminder: Return only the full code in <html></html> tags.\n'},...a.map((e=>({type:"image_url",image_url:{url:e}})))]})],g=u.pipe(new s);h.start(`Calling the ${d||"gpt-4o"} model`);const f=await g.invoke(p);h.succeed("The model successfully returns content");const y=f.substring(f.indexOf("<thinking>")+10,f.indexOf("</thinking>"));console.log("-----------模型分析过程\n",y,"\n-----------");const w=f.substring(f.indexOf("<!DOCTYPE html>"),f.lastIndexOf("</html>")+7);h.start("Start generating the file");const T=l(`./output_${new Date(Date.now()).toLocaleString().replace(/\/|:/g,"-").split(" ").join("_")}.html`);await t.writeFile(T,w,"utf-8"),h.succeed("Succeeded, Greate!")}catch(e){console.log(e),h.fail("Failed to output code")}})(await(async()=>{try{return JSON.parse(await t.readFile(l("./aimg2code.config.json")))}catch(e){throw console.log("【configuration file missed】: The aimg2code.config.json configuration file is missing"),e}})(),a.split(","))}();
